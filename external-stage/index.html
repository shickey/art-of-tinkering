<!DOCTYPE html>
<html>
<head>
  <title>Stage</title>
</head>
<style type="text/css">
  body {
    margin: 0;
    padding: 0;
    background-color: #000;
    width: 100%;
    height: 100vh;
  }
  
  canvas#stage {
    width: 100%;
    margin: 0 auto;
    display: block;
  }
</style>
<body>
  <canvas id="stage" width="1920" height="1080"></canvas>
</body>
<script type="text/javascript">
  var channel = new BroadcastChannel('stage-image');
  
  var canvas = document.getElementById('stage');
  var ctx = canvas.getContext('2d');
  ctx.transform(1, 0, 0, -1, 0, canvas.height);
  
  var width = 1920;
  var height = 1080;
  var stride = width * 4;
  
  // Create a (reusable) buffer for flipping the WebGL pixel data before rendering it
  var flipped = new Uint8ClampedArray(width * height * 4);
  
  channel.onmessage = (msg) => {
    var imgData = new Uint8Array(msg.data);
    
    // Flip y
    for (var i = 0; i < height; ++i) {
      flipped.set(imgData.subarray((height - 1 - i) * stride, (height - i) * stride), i * stride);
    }
    
    var flippedData = new ImageData(flipped, width, height);
    ctx.putImageData(flippedData, 0, 0);
  }

  var addConnection = function(connection) {
    connection.onmessage = function (message) {
      var imgData = new Uint8Array(message.data);
    
      // Flip y
      for (var i = 0; i < height; ++i) {
        flipped.set(imgData.subarray((height - 1 - i) * stride, (height - i) * stride), i * stride);
      }
      
      var flippedData = new ImageData(flipped, width, height);
      ctx.putImageData(flippedData, 0, 0);
    };
  };

  navigator.presentation.receiver.connectionList.then(function (list) {
    list.connections.map(function (connection) {
      addConnection(connection);
    });
    list.onconnectionavailable = function (evt) {
      addConnection(evt.connection);
    };
  });
</script>
</html>
